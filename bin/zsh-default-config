#!/bin/bash
#
# Copyright 2012-2016 Victor Penso
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

# Do not overwrite the existing configuration
if [ -e $HOME/.zshrc ] ; then
  echo "Zsh configuration ~/.zshrc exists!"
  exit 0
fi

if ! command -v zsh 2>&1 >/dev/null ; then
  # Debian based platform...
  if command -v apt 2>&1 >/dev/null ; then
    # Install
    sudo apt -qy install zsh
  fi
  # On Fedora...
  if command -v dnf 2>&1 >/dev/null ; then
    sudo dnf -qy install zsh
  fi
fi


mkdir ~/.zsh 2>/dev/null

##
# Download ZSH antigen
# https://github.com/zsh-users/antigen/releases
ANTIGEN_PATH=~/.zsh/antigen.zsh
wget -O $ANTIGEN_PATH https://github.com/zsh-users/antigen/releases/download/v2.2.1/antigen.zsh

cat > $HOME/.zshrc <<'EOF'
export HISTSIZE=10000
export SAVEHIST=10000
export HISTFILE=~/.zsh_history

setopt append_history
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_verify
setopt inc_append_history
setopt share_history

bindkey -e

##
# Antigen plugin manager for ZSH - https://github.com/zsh-users/antigen
#
ANTIGEN_CACHE=false
source ~/.zsh/antigen.zsh

antigen bundle git
# https://github.com/zsh-users/zsh-completions
antigen bundle zsh-users/zsh-completions

# https://github.com/zsh-users/zsh-autosuggestions
antigen bundle zsh-users/zsh-autosuggestions

# https://github.com/zsh-users/zsh-syntax-highlighting
antigen bundle zsh-users/zsh-syntax-highlighting

antigen bundle olivierverdier/zsh-git-prompt
antigen apply

ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets pattern cursor)
ZSH_HIGHLIGHT_STYLES+=(
  reserved-word          'fg=27,bold'
  command                'fg=27,bold'
  hashed-command         'fg=27,bold'
  alias                  'fg=39,bold'
  builtin                'fg=27,bold'
  function               'fg=39,bold'
  path                   'fg=246'
  single-quoted-argument 'fg=208,bold'
  double-quoted-argument 'fg=208,bold'
  cursor                 'bg=224,fg=124,bold'
)
export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=fg=252

NEWLINE=$'\n'
#PROMPT='%F{239}%n@%m%F{253}:%F{243}%~%k%f$NEWLINE$(git_super_status)%F{253}>>>%f '
PROMPT='%F{254}%n@%F{18}%m%F{253}:%F{33}%~ %F{254}%k%f $(git_super_status)$NEWLINE%F{88}>>>%f%k '


autoload -U colors && colors
if [ -f $HOME/.dir_colors/rainbow ] ; then
  eval $(dircolors $HOME/.dir_colors/rainbow)
fi

for file in `\ls ~/.zshrc.d/*`
do 
  source $file
done

export TERM="screen-256color"
EOF
echo "Configuration written to ~/.zshrc"

ln -s ~/.zshrc ~/.zshenv

mkdir ~/.zshrc.d 2>/dev/null

cat > $HOME/.zshrc.d/05_zsh_git_prompt <<'EOF'
export ZSH_THEME_GIT_PROMPT_PREFIX=""
export ZSH_THEME_GIT_PROMPT_SUFFIX=""
export ZSH_THEME_GIT_PROMPT_SEPARATOR=" %F{254}%f "
export ZSH_THEME_GIT_PROMPT_CLEAN=""
export ZSH_THEME_GIT_PROMPT_STAGED="%F{166}✔"
export ZSH_THEME_GIT_PROMPT_CONFLICTS="%F{166}✼"
export ZSH_THEME_GIT_PROMPT_CHANGED="%F{26}✎"
export ZSH_THEME_GIT_PROMPT_BRANCH="%F{243}"
export ZSH_THEME_GIT_PROMPT_UNTRACKED="%F{166}…"
export ZSH_THEME_GIT_PROMPT_BEHIND="%{⇣%G%}"
export ZSH_THEME_GIT_PROMPT_AHEAD="%{⇡%G%}"
EOF
echo "Configuration written to ~/.zshrc.d/05_zsh_git_prompt"

# make zsh default shell
user=$USER
shell=$(getent passwd $user | cut -d':' -f 7)
if [ ! "$shell" = "/bin/zsh" ] ; then
  sudo usermod --shell /bin/zsh $user
  echo "Re-login to your user account."
fi
